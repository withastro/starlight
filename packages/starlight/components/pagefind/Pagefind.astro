---
import { Icon } from '@astrojs/starlight/components';

const { t } = Astro.locals;
---

<starlight-pagefind>
	<form class="sl-flex">
		<div class="sl-pagefind-header">
			<label id="sl-pagefind-label" for="sl-pagefind-input" class="sr-only"
				>{t('search.label')}</label
			>
			<Icon name="magnifier" class="sl-pagefind-input-search-icon" />
			<input
				id="sl-pagefind-input"
				type="search"
				role="combobox"
				aria-autocomplete="list"
				aria-controls="sl-pagefind-results"
				aria-labelledby="sl-pagefind-label"
				autocapitalize="off"
				autocomplete="off"
				autocorrect="off"
				enterkeyhint="go"
				placeholder={t('search.label')}
				spellcheck="false"
			/>
			<button
				aria-label={t('search.pagefind.clear')}
				class="sl-pagefind-clear sl-hidden"
				title={t('search.pagefind.clear')}
				type="reset"
			>
				<Icon name="close" size="1.5rem" class="sl-pagefind-input-clear-icon" />
			</button>
		</div>
		<div class="sl-pagefind-content sl-flex">
			<fieldset class="sl-pagefind-filters sl-hidden">
				<legend class="sr-only">{t('search.pagefind.filters')}</legend>
			</fieldset>
			<div>
				<p aria-atomic="true" aria-live="polite" class="sl-pagefind-status"></p>
				<ul id="sl-pagefind-results" role="listbox" aria-labelledby="sl-pagefind-label"></ul>
			</div>
		</div>
		<div class="sl-pagefind-footer">
			<button class="sl-pagefind-show-more sl-hidden">{t('search.pagefind.loadMore')}</button>
		</div>
	</form>

	<template id="sl-pagefind-result-tpl">
		<starlight-pagefind-result>
			<li role="presentation">
				<a class="sl-flex" role="option" tabindex="-1">
					<div class="sl-pagefind-result-title"></div>
					<div class="sl-pagefind-result-excerpt"></div>
				</a>
			</li>
		</starlight-pagefind-result>
	</template>

	<template id="sl-pagefind-meta-tpl">
		<starlight-pagefind-meta>
			<li></li>
		</starlight-pagefind-meta>
	</template>

	<template id="sl-pagefind-filter-tpl">
		<starlight-pagefind-filter>
			<details>
				<summary></summary>
			</details>
		</starlight-pagefind-filter>
	</template>
</starlight-pagefind>

<script src="./starlight-pagefind"></script>
<script src="./starlight-pagefind-result"></script>
<script src="./starlight-pagefind-meta"></script>
<script src="./starlight-pagefind-filter"></script>

<style>
	@layer starlight.core {
		starlight-pagefind {
			--sl-pagefind-ui-bg: var(--sl-color-black);
			--sl-pagefind-ui-border: 1px solid var(--sl-color-gray-5);
			--sl-pagefind-results-corners: 0.25rem;
			--sl-pagefind-result-pad-inline-start: 3rem;
			--sl-pagefind-root-result-icon-size: 1.5rem;
			--sl-pagefind-root-result-icon-pad-inline-start: calc(
				(var(--sl-pagefind-result-pad-inline-start) - var(--sl-pagefind-root-result-icon-size)) / 2
			);
			--sl-pagefind-root-result-icon-url: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='currentColor' viewBox='0 0 24 24'%3E%3Cpath d='M9 10h1a1 1 0 1 0 0-2H9a1 1 0 0 0 0 2Zm0 2a1 1 0 0 0 0 2h6a1 1 0 0 0 0-2H9Zm11-3V8l-6-6a1 1 0 0 0-1 0H7a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V9Zm-6-4 3 3h-2a1 1 0 0 1-1-1V5Zm4 14a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h5v3a3 3 0 0 0 3 3h3v9Zm-3-3H9a1 1 0 0 0 0 2h6a1 1 0 0 0 0-2Z'/%3E%3C/svg%3E");
			--sl-pagefind-sub-result-icon-size: 2rem;
			--sl-pagefind-sub-result-icon-pad-inline-start: calc(
				(var(--sl-pagefind-result-pad-inline-start) - var(--sl-pagefind-sub-result-icon-size)) / 2
			);
			--sl-pagefind-sub-result-icon-url: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='currentColor' stroke-linecap='round' viewBox='0 0 16 1000' preserveAspectRatio='xMinYMin slice'%3E%3Cpath d='M8 0v1000m6-988H8'/%3E%3C/svg%3E");
			--sl-pagefind-sub-result-last-icon-url: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' viewBox='0 0 16 16'%3E%3Cpath d='M8 0v12m6 0H8'/%3E%3C/svg%3E");
			--sl-pagefind-filter-marker-url: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M14.8 11.3 10.6 7a1 1 0 1 0-1.4 1.5l3.5 3.5-3.5 3.5a1 1 0 0 0 0 1.4 1 1 0 0 0 .7.3 1 1 0 0 0 .7-.3l4.2-4.2a1 1 0 0 0 0-1.4Z'/%3E%3C/svg%3E%0A");

			overflow-y: hidden;
		}

		form {
			color: var(--sl-color-text);
			flex-direction: column;
			height: 100%;
			position: relative;
		}

		.sl-pagefind-header,
		.sl-pagefind-footer {
			background-color: var(--sl-color-black);
			padding: var(--sl-pagefind-ui-pad);
		}

		.sl-pagefind-header {
			border-bottom: var(--sl-pagefind-ui-border);
		}

		.sl-pagefind-input-search-icon {
			inset-block-start: calc(var(--sl-pagefind-ui-pad) + 1.15rem);
			inset-inline-start: calc(var(--sl-pagefind-ui-pad) + 1rem);
			position: absolute;
		}

		input[type='search'] {
			background-color: var(--sl-color-gray-6);
			border: var(--sl-pagefind-ui-border);
			border-radius: 0.5rem;
			color: var(--sl-color-white);
			font-weight: 400;
			height: 3.2rem;
			padding-inline: 2.7rem 3.5rem;
			width: calc(100% - var(--sl-search-cancel-space));
		}

		input[type='search']:focus {
			outline-color: var(--sl-color-accent);
		}

		input[type='search']::-webkit-search-cancel-button {
			display: none;
		}

		.sl-pagefind-clear {
			align-items: center;
			background-color: transparent;
			border: 0;
			border-radius: calc(0.5rem - 2px);
			inset-inline-end: max(
				calc(var(--sl-pagefind-ui-pad) + 0.15rem),
				calc(var(--sl-pagefind-ui-pad) + var(--sl-search-cancel-space))
			);
			inset-block-start: calc(var(--sl-pagefind-ui-pad) + 0.15rem);
			justify-content: center;
			height: 2.9rem;
			padding: 0;
			position: absolute;
			width: 3rem;
		}

		.sl-pagefind-clear:focus {
			outline: 1px solid var(--sl-color-accent);
		}

		.sl-pagefind-input-clear-icon {
			fill: var(--sl-color-text-accent);
		}

		.sl-pagefind-content {
			flex-direction: column;
			gap: 1rem;
			overflow-y: auto;
			padding: var(--sl-pagefind-ui-pad);
			padding-block-start: 0;
		}

		@media (min-width: 38rem) {
			.sl-pagefind-content {
				flex-direction: row;
			}

			.sl-pagefind-content > fieldset::after,
			.sl-pagefind-content > div:after {
				content: '';
				display: block;
				height: var(--sl-pagefind-ui-pad);
			}
		}

		.sl-pagefind-filters {
			border: 0;
			font-size: var(--sl-text-xs);
			min-width: 13rem;
			padding: 0;
		}

		starlight-pagefind-filter details {
			border-bottom: var(--sl-pagefind-ui-border);
			padding-block: 1rem;
		}

		starlight-pagefind-filter summary {
			cursor: pointer;
			display: block; /* Needed to hide the default marker in some browsers. */
			font-weight: 700;
			/* Expand the outline so that the marker cannot distort it. */
			margin-inline-start: -0.5rem;
			padding-inline-start: 0.5rem;
		}

		/* <summary> marker styles */
		starlight-pagefind-filter summary:is(::marker, ::-webkit-details-marker) {
			display: none;
		}
		starlight-pagefind-filter summary::before {
			--sl-details-marker-size: 1.25rem;

			background-color: currentColor;
			content: '';
			display: inline-block;
			height: var(--sl-details-marker-size);
			margin-inline: calc((var(--sl-details-marker-size) / 4) * -1) 0.25rem;
			-webkit-mask-image: var(--sl-pagefind-filter-marker-url);
			mask-image: var(--sl-pagefind-filter-marker-url);
			-webkit-mask-repeat: no-repeat;
			mask-repeat: no-repeat;
			vertical-align: middle;
			width: var(--sl-details-marker-size);
		}
		@media (prefers-reduced-motion: no-preference) {
			starlight-pagefind-filter summary::before {
				transition: transform 0.2s ease-in-out;
			}
		}
		starlight-pagefind-filter details[open] > summary::before {
			transform: rotateZ(90deg);
		}
		[dir='rtl'] starlight-pagefind-filter summary::before {
			transform: rotateZ(180deg);
		}

		starlight-pagefind-filter details :global(div) {
			align-items: center;
			display: flex;
			gap: 0.5rem;
			margin-top: 1rem;
		}

		starlight-pagefind-filter details :global(div > label) {
			flex: 1;
		}

		.sl-pagefind-status {
			font-size: var(--sl-text-xs);
			font-weight: 700;
			margin-top: 1rem;
		}

		ul {
			list-style-type: none;
			padding-inline-start: 0;
		}

		starlight-pagefind-result:has(+ starlight-pagefind-result[data-sl-pagefind-sub-result]) a {
			margin-block-end: 1px;
		}

		starlight-pagefind-result[data-sl-pagefind-root-result] a {
			border-start-start-radius: var(--sl-pagefind-results-corners);
			border-start-end-radius: var(--sl-pagefind-results-corners);
			margin-block-start: 1rem;
		}

		starlight-pagefind-result:is(
				:has(+ starlight-pagefind-result[data-sl-pagefind-root-result]),
				:last-of-type:not(:has(+ starlight-pagefind-meta))
			)
			a,
		starlight-pagefind-meta li {
			border-end-start-radius: var(--sl-pagefind-results-corners);
			border-end-end-radius: var(--sl-pagefind-results-corners);
		}

		starlight-pagefind-result li {
			position: relative;
		}

		starlight-pagefind-result a::before {
			content: '';
			inset-block: 0;
			position: absolute;
		}
		starlight-pagefind-result[data-sl-pagefind-root-result] a::before {
			background: var(--sl-color-gray-3);
			inset-inline-start: var(--sl-pagefind-root-result-icon-pad-inline-start);
			-webkit-mask: var(--sl-pagefind-root-result-icon-url) center no-repeat;
			mask: var(--sl-pagefind-root-result-icon-url) center no-repeat;
			width: var(--sl-pagefind-root-result-icon-size);
		}
		starlight-pagefind-result[data-sl-pagefind-sub-result] a::before {
			background: var(--sl-color-gray-4);
			inset-inline-start: var(--sl-pagefind-sub-result-icon-pad-inline-start);
			-webkit-mask: var(--sl-pagefind-sub-result-icon-url) 0% 0% / 100% no-repeat;
			mask: var(--sl-pagefind-sub-result-icon-url) 0% 0% / 100% no-repeat;
			width: var(--sl-pagefind-sub-result-icon-size);
		}
		starlight-pagefind-result[data-sl-pagefind-sub-result]:not(
				:has(+ starlight-pagefind-result[data-sl-pagefind-sub-result])
			)
			a::before {
			-webkit-mask-image: var(--sl-pagefind-sub-result-last-icon-url);
			mask-image: var(--sl-pagefind-sub-result-last-icon-url);
		}
		:global([dir='rtl']) starlight-pagefind-result a::before {
			transform: matrix(-1, 0, 0, 1, 0, 0);
		}

		starlight-pagefind-result a,
		starlight-pagefind-meta li {
			background-color: var(--sl-pagefind-ui-bg);
			color: var(--sl-color-white);
			padding-block: 0.5rem;
			padding-inline: var(--sl-pagefind-result-pad-inline-start) 1rem;
		}

		starlight-pagefind-result a {
			flex-direction: column;
			overflow-wrap: anywhere;
			text-decoration: none;
		}

		starlight-pagefind-result a:hover,
		:has(input[type='search']:focus) starlight-pagefind-result a[aria-selected='true'] {
			outline: 1px solid var(--sl-color-accent-high);
		}

		:has(input[type='search']:focus) starlight-pagefind-result a[aria-selected='true'] {
			background-color: var(--sl-color-accent-low);
		}

		.sl-pagefind-result-title {
			font-size: 0.945rem;
			font-weight: 600;
		}

		.sl-pagefind-result-excerpt {
			color: var(--sl-color-text);
			font-size: 0.8rem;
		}

		starlight-pagefind-result :global(mark) {
			background-color: transparent;
			color: var(--sl-color-gray-2);
			font-weight: 600;
		}

		starlight-pagefind-meta li {
			margin-block-start: 1px;
		}

		starlight-pagefind-meta :global(li) {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			padding-inline-start: 1rem;
		}

		starlight-pagefind-meta :global(div) {
			background-color: var(--sl-color-gray-5);
			border-radius: var(--sl-pagefind-results-corners);
			color: var(--sl-color-text);
			font-size: var(--sl-text-xs);
			padding: 0.2rem 0.4rem;
		}

		:root[data-theme='light'] starlight-pagefind-meta :global(div) {
			background-color: var(--sl-color-gray-6);
		}

		.sl-pagefind-footer {
			border-top: var(--sl-pagefind-ui-border);
		}

		.sl-pagefind-footer:has(> .sl-pagefind-show-more.sl-hidden) {
			display: none;
		}

		.sl-pagefind-show-more {
			background-color: var(--sl-color-gray-6);
			border: var(--sl-pagefind-ui-border);
			border-radius: var(--sl-pagefind-results-corners);
			color: var(--sl-color-text);
			cursor: pointer;
			font-size: var(--sl-text-xs);
			font-weight: 700;
			padding-block: 0.5rem;
			width: 100%;
		}

		.sl-pagefind-show-more:is(:hover, :focus) {
			border-color: var(--sl-color-white);
			color: var(--sl-color-white);
		}
	}
</style>
